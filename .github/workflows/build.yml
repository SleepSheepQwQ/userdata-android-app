name: Build Android APK

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK with latest cmdline-tools
      run: |
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
        unzip -q commandlinetools-linux-11076708_latest.zip
        mkdir -p $HOME/android-sdk/cmdline-tools/latest
        mv cmdline-tools/* $HOME/android-sdk/cmdline-tools/latest/
        
        echo "ANDROID_HOME=$HOME/android-sdk" >> $GITHUB_ENV
        echo "ANDROID_SDK_ROOT=$HOME/android-sdk" >> $GITHUB_ENV
        echo "$HOME/android-sdk/cmdline-tools/latest/bin" >> $GITHUB_PATH
        echo "$HOME/android-sdk/platform-tools" >> $GITHUB_PATH

    - name: Install Android components (ä¿®å¤åŒ…å)
      run: |
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager \
          "platform-tools" \
          "platforms;android-30" \
          "platforms;android-34" \
          "build-tools;30.0.3" \
          "build-tools;34.0.0" \
          "ndk;25.1.8937393"
        
        # è®¾ç½® NDK ç¯å¢ƒå˜é‡
        echo "NDK_HOME=$ANDROID_HOME/ndk/25.1.8937393" >> $GITHUB_ENV
        echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/25.1.8937393" >> $GITHUB_ENV

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: aarch64-linux-android

    - name: Install cargo-apk
      run: cargo install cargo-apk

    - name: æ™ºèƒ½é¡¹ç›®æ£€æµ‹ä¸æ„å»º
      run: |
        echo "ğŸ” === æ™ºèƒ½é¡¹ç›®ç»“æ„æ£€æµ‹ ==="
        
        # 1. æŸ¥æ‰¾æ‰€æœ‰ Cargo.toml æ–‡ä»¶
        CARGO_FILES=$(find . -name "Cargo.toml" -type f)
        echo "å‘ç°çš„ Cargo.tomlï¼š"
        echo "$CARGO_FILES"
        
        if [ -z "$CARGO_FILES" ]; then
          echo "âŒ æœªæ‰¾åˆ°ä»»ä½• Cargo.toml"
          echo "ğŸ“ å½“å‰ç›®å½•ç»“æ„ï¼š"
          find . -maxdepth 3 -type f \( -name "*.toml" -o -name "*.rs" \) | head -20
          exit 1
        fi
        
        # 2. æ™ºèƒ½é€‰æ‹©ä¸»é¡¹ç›®ç›®å½•
        MAIN_PROJECT_DIR=""
        MAX_RS_COUNT=0
        
        for cargo_file in $CARGO_FILES; do
          PROJECT_DIR=$(dirname "$cargo_file")
          RS_COUNT=$(find "$PROJECT_DIR" -name "*.rs" -type f 2>/dev/null | wc -l)
          echo "ğŸ“Š $PROJECT_DIR: $RS_COUNT ä¸ª .rs æ–‡ä»¶"
          
          if [ $RS_COUNT -gt $MAX_RS_COUNT ]; then
            MAX_RS_COUNT=$RS_COUNT
            MAIN_PROJECT_DIR="$PROJECT_DIR"
          fi
        done
        
        echo "âœ… é€‰æ‹©ä¸»é¡¹ç›®ç›®å½•ï¼š$MAIN_PROJECT_DIR"
        
        # 3. éªŒè¯å¹¶è¿›å…¥é¡¹ç›®ç›®å½•
        cd "$MAIN_PROJECT_DIR" || exit 1
        
        if [ ! -f "Cargo.toml" ]; then
          echo "âŒ æ— æ³•åœ¨ $MAIN_PROJECT_DIR æ‰¾åˆ° Cargo.toml"
          exit 1
        fi
        
        echo "ğŸ“‹ é¡¹ç›®ä¿¡æ¯ï¼š"
        echo "ç›®å½•ï¼š$(pwd)"
        echo "é¡¹ç›®åç§°ï¼š$(grep -E '^name = ' Cargo.toml | head -1)"
        
        # 4. æ£€æŸ¥ Android é…ç½®
        if ! grep -q "crate-type.*cdylib" Cargo.toml; then
          echo "âš ï¸  æœªå‘ç° cdylib é…ç½®ï¼Œå¯èƒ½å½±å“ Android æ„å»º"
        fi
        
        echo ""
        echo "ğŸš€ === å¼€å§‹æ„å»º ==="
        
        # 5. æ‰§è¡Œæ„å»º
        if cargo apk build --release --target aarch64-linux-android 2>&1 | tee build.log; then
          echo "BUILD_STATUS=0" >> $GITHUB_ENV
          echo "âœ… æ„å»ºæˆåŠŸ"
        else
          echo "BUILD_STATUS=1" >> $GITHUB_ENV
          echo "âŒ æ„å»ºå¤±è´¥"
        fi
        
        # 6. ä¿å­˜ç¯å¢ƒå˜é‡
        echo "PROJECT_DIR=$(pwd)" >> $GITHUB_ENV

    - name: é”™è¯¯åˆ†æä¸è¯Šæ–­
      if: always() && env.BUILD_STATUS == '1'
      run: |
        echo "ğŸ” === æ„å»ºé”™è¯¯è¯Šæ–­ ==="
        
        if [ -f "${{ env.PROJECT_DIR }}/build.log" ]; then
          echo "âŒ ç¼–è¯‘é”™è¯¯æ‘˜è¦ï¼š"
          grep -E "^error\[|^   --> [0-9]+:[0-9]+|help:|note:" "${{ env.PROJECT_DIR }}/build.log" | head -15 || echo "æ— å…·ä½“é”™è¯¯ä¿¡æ¯"
          
          echo ""
          echo "ğŸ”§ é”™è¯¯ä»£ç ï¼š"
          grep -oE "E[0-9]{4}" "${{ env.PROJECT_DIR }}/build.log" | sort -u | tr '\n' ' ' || echo "æ— é”™è¯¯ä»£ç "
          
          echo ""
          echo "ğŸ“„ æ„å»ºæ—¥å¿—æœ«å°¾ï¼š"
          tail -15 "${{ env.PROJECT_DIR }}/build.log"
        fi

    - name: æ™ºèƒ½ APK æœç´¢
      if: always()
      run: |
        echo "ğŸ” === å…¨é¢ APK æœç´¢ ==="
        
        # å®šä¹‰æ‰€æœ‰å¯èƒ½çš„ APK ä½ç½®
        POSSIBLE_PATHS=(
          "${{ env.PROJECT_DIR }}/target/aarch64-linux-android/release/*.apk"
          "${{ env.PROJECT_DIR }}/target/aarch64-linux-android/debug/*.apk"
          "${{ env.PROJECT_DIR }}/target/*/release/*.apk"
          "${{ env.PROJECT_DIR }}/target/*/debug/*.apk"
          "./target/aarch64-linux-android/release/*.apk"
          "./target/aarch64-linux-android/debug/*.apk"
          "./*/*.apk"
          "./*.apk"
        )
        
        FOUND_APK=""
        
        for path_pattern in "${POSSIBLE_PATHS[@]}"; do
          echo "ğŸ” æ£€æŸ¥ï¼š$path_pattern"
          FOUND=$(find . -name "*.apk" -type f 2>/dev/null)
          
          if [ -n "$FOUND" ]; then
            echo "âœ… æ‰¾åˆ° APKï¼š"
            echo "$FOUND"
            FOUND_APK=$(echo "$FOUND" | head -1)
            break
          fi
        done
        
        if [ -n "$FOUND_APK" ]; then
          echo "APK_PATH=$FOUND_APK" >> $GITHUB_ENV
          echo "ğŸ“¦ é€‰æ‹©çš„ APKï¼š$FOUND_APK"
        else
          echo "âŒ æœªæ‰¾åˆ° APK æ–‡ä»¶"
          echo ""
          echo "ğŸ“ ç›®å½•ç»“æ„åˆ†æï¼š"
          find . -type d -name "target" 2>/dev/null | head -10 || echo "æ—  target ç›®å½•"
          echo ""
          echo "ğŸ” æ‰€æœ‰æ„å»ºäº§ç‰©ï¼š"
          find . -name "*.apk" -o -name "*.so" -o -name "*.a" 2>/dev/null | head -20 || echo "æ— æ„å»ºäº§ç‰©"
          echo "APK_PATH=" >> $GITHUB_ENV
        fi

    - name: ä¸Šä¼  APK äº§ç‰©ï¼ˆé˜²å¾¡æ€§å¤„ç†ï¼‰
      if: always() && env.BUILD_STATUS == '0' && env.APK_PATH != ''
      uses: actions/upload-artifact@v4
      with:
        name: userdata-rust-apk
        path: ${{ env.APK_PATH }}
        retention-days: 30

    - name: ä¸Šä¼ æ„å»ºæ—¥å¿—ï¼ˆé˜²å¾¡æ€§å¤„ç†ï¼‰
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-debug-logs
        path: |
          ${{ env.PROJECT_DIR }}/build.log
          ${{ env.PROJECT_DIR }}/target/
        retention-days: 7
        continue-on-error: true

    - name: æœ€ç»ˆçŠ¶æ€æŠ¥å‘Š
      if: always()
      run: |
        echo "=== æ„å»ºæ€»ç»“ ==="
        echo "æ„å»ºçŠ¶æ€ï¼š${{ env.BUILD_STATUS }}"
        echo "é¡¹ç›®ç›®å½•ï¼š${{ env.PROJECT_DIR }}"
        echo "APK è·¯å¾„ï¼š${{ env.APK_PATH }}"
        
        if [ "${{ env.BUILD_STATUS }}" == "0" ] && [ -n "${{ env.APK_PATH }}" ]; then
          echo "ğŸ‰ æ„å»ºå®Œå…¨æˆåŠŸï¼APK å·²ä¸Šä¼ ã€‚"
        elif [ "${{ env.BUILD_STATUS }}" == "0" ]; then
          echo "âš ï¸  æ„å»ºæˆåŠŸä½†æœªæ‰¾åˆ° APKï¼Œè¯·æ£€æŸ¥é¡¹ç›®é…ç½®ã€‚"
        else
          echo "âŒ æ„å»ºå¤±è´¥ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ã€‚"
        fi
