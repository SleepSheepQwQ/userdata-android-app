name: Build Android APK

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK with latest cmdline-tools
      run: |
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
        unzip -q commandlinetools-linux-11076708_latest.zip
        mkdir -p $HOME/android-sdk/cmdline-tools/latest
        mv cmdline-tools/* $HOME/android-sdk/cmdline-tools/latest/
        
        echo "ANDROID_HOME=$HOME/android-sdk" >> $GITHUB_ENV
        echo "ANDROID_SDK_ROOT=$HOME/android-sdk" >> $GITHUB_ENV
        echo "$HOME/android-sdk/cmdline-tools/latest/bin" >> $GITHUB_PATH
        echo "$HOME/android-sdk/platform-tools" >> $GITHUB_PATH

    - name: Install Android components
      run: |
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "platform-tools" "platforms;android-30" "platforms;android-34" "build-tools;30.0.3" "build-tools:34.0.0"

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: aarch64-linux-android

    - name: Install cargo-apk
      run: cargo install cargo-apk

    - name: Auto-detect project structure and build
      run: |
        echo "ğŸ” === é¡¹ç›®ç»“æ„è‡ªåŠ¨æ£€æµ‹ ==="
        
        # 1. æŸ¥æ‰¾æ‰€æœ‰ Cargo.toml æ–‡ä»¶
        CARGO_FILES=$(find . -name "Cargo.toml" -type f)
        echo "å‘ç°çš„ Cargo.toml æ–‡ä»¶ï¼š"
        echo "$CARGO_FILES"
        
        if [ -z "$CARGO_FILES" ]; then
          echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°ä»»ä½• Cargo.toml æ–‡ä»¶"
          echo "ğŸ“ å½“å‰ç›®å½•ç»“æ„ï¼š"
          find . -maxdepth 3 -type f -name "*.toml" -o -name "*.rs" | head -20
          exit 1
        fi
        
        # 2. ç¡®å®šä¸»é¡¹ç›®ç›®å½•ï¼ˆé€‰æ‹©åŒ…å«æœ€å¤š .rs æ–‡ä»¶çš„ Cargo.tomlï¼‰
        MAIN_PROJECT_DIR=""
        MAX_RS_COUNT=0
        
        for cargo_file in $CARGO_FILES; do
          PROJECT_DIR=$(dirname "$cargo_file")
          RS_COUNT=$(find "$PROJECT_DIR" -name "*.rs" -type f | wc -l)
          echo "ğŸ“Š $PROJECT_DIR: $RS_COUNT ä¸ª .rs æ–‡ä»¶"
          
          if [ $RS_COUNT -gt $MAX_RS_COUNT ]; then
            MAX_RS_COUNT=$RS_COUNT
            MAIN_PROJECT_DIR="$PROJECT_DIR"
          fi
        done
        
        echo ""
        echo "âœ… æ£€æµ‹åˆ°ä¸»é¡¹ç›®ç›®å½•ï¼š$MAIN_PROJECT_DIR"
        echo "ğŸ“ åŒ…å« $MAX_RS_COUNT ä¸ª Rust æºæ–‡ä»¶"
        
        # 3. è¿›å…¥é¡¹ç›®ç›®å½•å¹¶éªŒè¯
        cd "$MAIN_PROJECT_DIR"
        
        if [ ! -f "Cargo.toml" ]; then
          echo "âŒ é”™è¯¯ï¼šæ— æ³•åœ¨ $MAIN_PROJECT_DIR æ‰¾åˆ° Cargo.toml"
          exit 1
        fi
        
        echo ""
        echo "ğŸ“‹ é¡¹ç›®ä¿¡æ¯ï¼š"
        echo "ç›®å½•ï¼š$(pwd)"
        echo "Cargo.toml å†…å®¹é¢„è§ˆï¼š"
        head -10 Cargo.toml
        
        # 4. æ£€æŸ¥æ˜¯å¦ä¸º Android é¡¹ç›®
        if ! grep -q "crate-type.*cdylib" Cargo.toml; then
          echo "âš ï¸  è­¦å‘Šï¼šæœªå‘ç° cdylib é…ç½®ï¼Œå¯èƒ½ä¸æ˜¯ Android é¡¹ç›®"
        fi
        
        echo ""
        echo "ğŸš€ === å¼€å§‹æ„å»º ==="
        
        # 5. æ„å»º
        BUILD_OUTPUT_DIR="../build_output"
        mkdir -p "$BUILD_OUTPUT_DIR"
        
        if cargo apk build --release --target aarch64-linux-android 2>&1 | tee "$BUILD_OUTPUT_DIR/build.log"; then
          echo "BUILD_STATUS=0" >> $GITHUB_ENV
          echo "âœ… æ„å»ºæˆåŠŸ"
        else
          echo "BUILD_STATUS=1" >> $GITHUB_ENV
          echo "âŒ æ„å»ºå¤±è´¥"
        fi
        
        # 6. ä¿å­˜é¡¹ç›®è·¯å¾„ä¾›åç»­æ­¥éª¤ä½¿ç”¨
        echo "PROJECT_DIR=$(pwd)" >> $GITHUB_ENV
        echo "BUILD_OUTPUT_DIR=$BUILD_OUTPUT_DIR" >> $GITHUB_ENV

    - name: Extract and display errors
      if: always() && env.BUILD_STATUS == '1'
      run: |
        echo "ğŸ” === æ„å»ºé”™è¯¯åˆ†æ ==="
        
        if [ -f "${{ env.BUILD_OUTPUT_DIR }}/build.log" ]; then
          echo "âŒ Rust ç¼–è¯‘é”™è¯¯ï¼š"
          grep -E "^error\[|^   --> [0-9]+:[0-9]+|help:|note:" "${{ env.BUILD_OUTPUT_DIR }}/build.log" | head -20 || echo "æ— å…·ä½“ç¼–è¯‘é”™è¯¯"
          
          echo ""
          echo "ğŸ”§ é”™è¯¯ä»£ç ï¼š"
          grep -oE "E[0-9]{4}" "${{ env.BUILD_OUTPUT_DIR }}/build.log" | sort -u | tr '\n' ' ' || echo "æ— é”™è¯¯ä»£ç "
          
          echo ""
          echo "ğŸ“„ æ„å»ºæ—¥å¿—æœ€å 20 è¡Œï¼š"
          tail -20 "${{ env.BUILD_OUTPUT_DIR }}/build.log"
        fi

    - name: Intelligent APK discovery
      if: always()
      run: |
        echo "ğŸ” === æ™ºèƒ½ APK æœç´¢ ==="
        
        # å®šä¹‰æ‰€æœ‰å¯èƒ½çš„æœç´¢è·¯å¾„æ¨¡å¼
        SEARCH_PATTERNS=(
          "${{ env.PROJECT_DIR }}/target/aarch64-linux-android/release/*.apk"
          "${{ env.PROJECT_DIR }}/target/aarch64-linux-android/debug/*.apk"
          "${{ env.PROJECT_DIR }}/target/*/release/*.apk"
          "${{ env.PROJECT_DIR }}/target/*/debug/*.apk"
          "./target/aarch64-linux-android/release/*.apk"
          "./target/aarch64-linux-android/debug/*.apk"
          "./*/*.apk"
          "./*.apk"
        )
        
        FOUND_APKS=""
        
        for pattern in "${SEARCH_PATTERNS[@]}"; do
          echo "ğŸ” æœç´¢æ¨¡å¼ï¼š$pattern"
          FOUND=$(find . -name "*.apk" -type f 2>/dev/null | grep -E "$(echo "$pattern" | sed 's/\*/.*/g')" || true)
          
          if [ -n "$FOUND" ]; then
            echo "âœ… æ‰¾åˆ° APKï¼š"
            echo "$FOUND"
            FOUND_APKS="$FOUND_APKS$FOUND\n"
          fi
        done
        
        if [ -n "$FOUND_APKS" ]; then
          FIRST_APK=$(echo -e "$FOUND_APKS" | head -1 | tr -d '\n')
          echo "APK_PATH=$FIRST_APK" >> $GITHUB_ENV
          echo "ğŸ“¦ é€‰æ‹© APKï¼š$FIRST_APK"
        else
          echo "âŒ æœªæ‰¾åˆ°ä»»ä½• APK æ–‡ä»¶"
          echo ""
          echo "ğŸ“ å®Œæ•´ç›®å½•ç»“æ„åˆ†æï¼š"
          find . -type d -name "target" -exec find {} -type f \; 2>/dev/null | head -30 || echo "æ—  target ç›®å½•"
          echo ""
          echo "ğŸ” æ‰€æœ‰æ„å»ºäº§ç‰©ï¼š"
          find . -name "*.apk" -o -name "*.so" -o -name "*.a" 2>/dev/null | head -20 || echo "æ— æ„å»ºäº§ç‰©"
          echo "APK_PATH=" >> $GITHUB_ENV
        fi

    - name: Upload APK artifact
      if: success() && env.BUILD_STATUS == '0' && env.APK_PATH != ''
      uses: actions/upload-artifact@v4
      with:
        name: userdata-rust-apk
        path: ${{ env.APK_PATH }}
        retention-days: 30

    - name: Upload comprehensive build log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-debug-info
        path: ${{ env.BUILD_OUTPUT_DIR }}
        retention-days: 7

    - name: Final comprehensive status
      if: always()
      run: |
        echo "=== æ„å»ºæ€»ç»“ ==="
        echo "æ„å»ºçŠ¶æ€ï¼š${{ env.BUILD_STATUS }}"
        echo "é¡¹ç›®ç›®å½•ï¼š${{ env.PROJECT_DIR }}"
        echo "APK è·¯å¾„ï¼š${{ env.APK_PATH }}"
        
        if [ "${{ env.BUILD_STATUS }}" == "0" ] && [ -n "${{ env.APK_PATH }}" ]; then
          echo "ğŸ‰ æ„å»ºå®Œå…¨æˆåŠŸï¼APK å·²ä¸Šä¼ ã€‚"
        elif [ "${{ env.BUILD_STATUS }}" == "0" ]; then
          echo "âš ï¸  æ„å»ºæˆåŠŸä½†æœªæ‰¾åˆ° APKã€‚æ£€æŸ¥é¡¹ç›®é…ç½®ã€‚"
        else
          echo "âŒ æ„å»ºå¤±è´¥ã€‚æŸ¥çœ‹è¯¦ç»†æ—¥å¿—è¿›è¡Œè¯Šæ–­ã€‚"
        fi
